# Copyright 2020 Florian Schmaus
# Distributed under the terms of the GNU General Public License v3 (or any later version)
#!/usr/bin/env bash
set -euo pipefail

shopt -s globstar

while getopts :d OPT; do
	case $OPT in
		d)
			set -x
			;;
		*)
			print "usage: ${0##*/} [-d] [--]"
			exit 2
	esac
done

readonly GENTOO_ENV_DIR="/etc/env.d"
readonly SYSTEMD_ENV_DIR="/usr/lib/environment.d"
readonly GENTOO_SYSTEMD_ENV_PREFIX="gentoo-env"

transform_gentoo_env_file() {
	local source_path="${1}"
	local source_file="$(basename ${source_path})"

	# TODO: mangle subdirectories found in /etc/env.d into this.
	local dest_file="${GENTOO_SYSTEMD_ENV_PREFIX}-${source_file}.conf"

	cp "${source_path}" "${SYSTEMD_ENV_DIR}/${dest_file}"
}

# Delete existing.
rm -f "${SYSTEMD_ENV_DIR}/${GENTOO_SYSTEMD_ENV_PREFIX}*"

for gentoo_env_path in "${GENTOO_ENV_DIR}"/* "${GENTOO_ENV_DIR}"/**/*; do
	if [[ ! -f ${gentoo_env_path} ]]; then
		continue;
	fi

	transform_gentoo_env_file "${gentoo_env_path}"
done
